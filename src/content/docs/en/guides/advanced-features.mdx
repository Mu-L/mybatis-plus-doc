---
title: Advanced Features
sidebar:
  order: 19
---
import { LinkCard } from '@astrojs/starlight/components';

Mybatis-Mate is an enterprise-level module for MyBatis-Plus, designed to handle data more efficiently and elegantly.

-   Example Usage: [Portal](https://gitee.com/baomidou/mybatis-mate-examples)
-   Contact the author for confirmation. If you publish an introductory article about Mybatis-Mate on your official WeChat account, you can receive a free permanent personal license certificate.
-   This module is an extension library for MyBatis-Plus, not a paid version of MyBatis-Plus. Any issues are the sole responsibility of `ÈùíËãó`.

<LinkCard
  title="Free Video Tutorials"
  description="Produced by ÈùíËãó, Quality Guaranteed"
  href="https://space.bilibili.com/212983666/channel/collectiondetail?sid=606288"
/>

## Data Auditing (Reconciliation)

- Usage example: üëâ [mybatis-mate-audit](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/mybatis-mate-audit)
- Compare property differences between two objects, for example: bank statement reconciliation.
  ```java
  // 1. Asynchronous callback, note: enable async with @EnableAsync
  applicationEventPublisher.publishEvent(new DataAuditEvent((t) -> {
      List<Change> changes = t.apply(newVersion, oldVersion);
      for (Change valueChange : changes) {
          ValueChange change = (ValueChange) valueChange;
          System.err.println(String.format("%s doesn't match, expected value %s actual value %s", change.getPropertyName(), change.getLeft(), change.getRight()));
      }
  }));

  // 2. Manual comparison call
  DataAuditor.compare(obj1, obj2);
  ```

## Data Sensitive Word Filtering

- Example Usage üëâ [mybatis-mate-sensitive-words](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/mybatis-mate-sensitive-words)
- After configuring the processor for data sensitive word filtering (AC algorithm), the framework automatically filters sensitive words in all requested strings. It supports nested keywords, leaving no place for sensitive words to hide.
- The database maintains its own sensitive word library (free, controllable). By default, it loads cached word roots and supports specifying when to reload the word library.

## Data Scope (Data Permissions)

- Usage example: [mybatis-mate-datascope](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/mybatis-mate-datascope)
- Annotation @DataScope
  | Property | Type | Required | Default | Description |
  | :----: | :----------: | :------: | :----: | -------------------------------------- |
  | type | String | No | "" | Scope type, used to distinguish business categories, empty by default |
  | value | DataColumn[] | No | {} | Data permission fields, supports multi-field combinations |
  | ignore | boolean | No | false | Ignore permission processing logic true for yes, false for no |
- Annotation @DataColumn
  | Property | Type | Required | Default | Description |
  | :---: | :----: | :------: | :----: | ---------- |
  | alias | String | No | "" | Associated table alias |
  | name | String | Yes | | Field name |
- Row-level granular permission control, for example: a parent department can view sub-department information.
  ```java
  // Test data permission scope of type 'test', mixed pagination mode
  @DataScope(type = "test", value = {
          // Associate table user alias u to specify department field permissions
          @DataColumn(alias = "u", name = "department_id"),
          // Associate table user alias u to specify mobile field (handle as needed)
          @DataColumn(alias = "u", name = "mobile")
  })
  @Select("select u.* from user u")
  List<User> selectTestList(IPage<User> page, Long id, @Param("name") String username);

  // Test data permissions, final executed SQL statement
  SELECT u.* FROM user u WHERE (u.department_id IN ('1', '2', '3', '5')) AND u.mobile LIKE '%1533%' LIMIT 1,10
  ```

:::note[About `IDataScopeProvider`]

Please note that you must inject an IDataScopeProvider implementation class to handle data permissions. There are 2 supported ways to pass parameters:
1. Pass through method parameters in custom mapper methods, accessible via the `Object[] args` parameter in the setWhere method
2. Use ThreadLocal to pass parameters. You can intercept at the controller layer or service layer to set data permission processing parameters. For more information üëâ[refer to](https://gitee.com/baomidou/mybatis-plus-samples/tree/master/mybatis-plus-sample-dynamic-tablename)

:::

## Automatic Table Structure Maintenance

- Usage examples:
  - üëâ [mybatis-mate-ddl-mysql](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/mybatis-mate-ddl-mysql)
  - üëâ [mybatis-mate-ddl-postgres](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/mybatis-mate-ddl-postgres)
- Automatically maintains database `Schema` initialization and upgrade `SQL` scripts. Unlike `flyway`, it supports sharded databases and allows you to control SQL script execution through code.
- On first run, it creates a `ddl_history` table in your database and automatically maintains version information each time SQL scripts are executed.
  ```java
  @Component
  public class MysqlDdl implements IDdl {

      /**
       * Method to execute SQL scripts
       */
      @Override
      public List<String> getSqlFiles() {
          return Arrays.asList(
                  "db/tag-schema.sql",
                  "D:\\db\\tag-data.sql"
          );
      }
  }

  // Switch to MySQL replica and execute SQL scripts
  ShardingKey.change("mysqlt2");
  ddlScript.run(new StringReader("DELETE FROM user;\n" +
          "INSERT INTO user (id, username, password, sex, email) VALUES\n" +
          "(20, 'Duo', '123456', 0, 'Duo@baomidou.com');"));
  ```

## Field Data Binding (Dictionary Write-Back)

- Usage example: üëâ [mybatis-mate-dict](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/mybatis-mate-dict)
- Annotation @FieldBind
  | Property | Type | Required | Default | Description |
  | :------: | :----: | :------: | :----: | -------------------------------------------------- |
  | sharding | String | No | "" | Specifies the sharding data source |
  | type | String | Yes | | Type (used to distinguish between different businesses) |
  | target | String | Yes | | Target display property (property to bind, ensure you exclude non-database fields) |
- Database `sex` values `0`, `1` are automatically mapped to `Male`, `Female`
- You can bind and map to an object, for example: map to an order object or number based on the order ID
  ```java
  @FieldBind(type = "user_sex", target = "sexText")
  private Integer sex;
  // Bind display property, non-table dictionary (excluded)
  @TableField(exist = false)
  private String sexText;
  ```
- The binding business handler class needs to implement the IDataBind interface and be injected into the Spring container
  ```java
  @Component
  public class DataBind implements IDataBind {
    ...
  }
  ```

## Virtual Property Binding

- Usage example: üëâ [mybatis-mate-jsonbind](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/mybatis-mate-jsonbind)
- Annotation @JsonBind
  ```java
  @JsonBind("bindingType")
  public class User {
      ...
  }
  ```
- Return JSON virtual property binding strategy
  ```java
  @Component
  public class JsonBindStrategy implements IJsonBindStrategy {

      @Override
      public Map<String, Function<Object, Map<String, Object>>> getStrategyFunctionMap() {
          return new HashMap<String, Function<Object, Map<String, Object>>>(16) {
              {
                  // Inject virtual nodes
                  put(Type.departmentRole, (obj) -> new HashMap(2) {{
                      User user = (User) obj;
                      // Enum type conversion
                      put("statusText", StatusEnum.get(user.getStatus()).getDesc());
                      // Can call database to query role information
                      put("roleName", "Manager");
                  }});
              }
          };
      }
  }
  ```

## Field Encryption and Decryption

- Usage example: üëâ [mybatis-mate-encrypt](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/mybatis-mate-encrypt)
- Annotation @FieldEncrypt
  |   Attribute   |   Type    | Required |    Default Value    | Description          |
  | :-----------: | :-------: | :------: | :-----------------: | -------------------- |
  |   password    |  String   |    No    |         ""          | Encryption password  |
  |  algorithm    | Algorithm |    No    |  PBEWithMD5AndDES   | PBE MD5 DES hybrid algorithm |
  |   encryptor   |   Class   |    No    |     IEncryptor      | Encryption processor |
- Algorithm
  |          Algorithm           |               Description               |
  | :--------------------------: | :-------------------------------------: |
  |           MD5_32             |         32-bit MD5 algorithm            |
  |           MD5_16             |         16-bit MD5 algorithm            |
  |           BASE64             | Algorithm using 64 characters to represent any binary data |
  |             AES              | AES symmetric algorithm „ÄêUse this algorithm if fuzzy query is required„Äë |
  |             RSA              |         Asymmetric encryption algorithm         |
  |             SM2              | Chinese National Standard SM2 asymmetric encryption algorithm, based on ECC |
  |             SM3              | Chinese National Standard SM3 message digest algorithm, comparable to MD5 |
  |             SM4              | Chinese National Standard SM4 symmetric encryption algorithm, block data algorithm for WLAN standards |
  |      PBEWithMD5AndDES        |               Hybrid algorithm                |
  |   PBEWithMD5AndTripleDES     |               Hybrid algorithm                |
  | PBEWithHMACSHA512AndAES_256  |               Hybrid algorithm                |
  |    PBEWithSHA1AndDESede      |               Hybrid algorithm                |
  |    PBEWithSHA1AndRC2_40      |               Hybrid algorithm                |
- üëâ [Chinese National Standard SM2.3.4 Algorithm Usage Specification](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/%E5%9B%BD%E5%AF%86SM2.3.4%E7%AE%97%E6%B3%95%E4%BD%BF%E7%94%A8%E8%A7%84%E8%8C%83)
  :::note

  - The MD5 algorithm is irreversible; both the data stored in the database and the query results are ciphertext.
  - The SM4 algorithm requires the bouncycastle encryption library.
  - Hybrid algorithms require the jasypt encryption library.
  - „ÄêNote„ÄëThe encrypted object returned by a query must contain `encryption annotation` information. Simply returning a String or a List collection cannot be decrypted.

  :::
- The `@FieldEncrypt` annotation implements data encryption and decryption, supporting multiple encryption algorithms
  ```java
  @FieldEncrypt
  private String email;
  ```

## Field Desensitization

- Usage example: üëâ [mybatis-mate-sensitive-jackson](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/mybatis-mate-sensitive-jackson)
- Annotation @FieldSensitive
- The `@FieldSensitive` annotation implements data desensitization with 9 built-in common desensitization rules including `phone number`, `email`, and `bank card number`.

  ```java
  @FieldSensitive("testStrategy")
  private String username;

  @Configuration
  public class SensitiveStrategyConfig {

      /**
       * Inject desensitization strategy
       */
      @Bean
      public ISensitiveStrategy sensitiveStrategy() {
          // Custom testStrategy type desensitization handling
          return new SensitiveStrategy().addStrategy("testStrategy", t -> t + "***test***");
      }
  }

  // Skip desensitization processing for edit scenarios
  RequestDataTransfer.skipSensitive();
  ```

## Multiple Data Source Sharding and Read-Write Separation

- Example usage: üëâ [mybatis-mate-sharding](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/mybatis-mate-sharding)
- Annotation @Sharding
  | Property | Type | Required | Default Value | Description |
  | :------: | :----: | :------: | :--------------------: | ---------------------------- |
  | value | String | Yes | "" | Sharding group name, empty uses default primary data source |
  | strategy | Class | No | RandomShardingStrategy | Sharding & table splitting strategy |
- Configuration
  ```xml
  mybatis-mate:
    sharding:
      health: true # Health check
      primary: mysql # Default selected data source
      datasource:
        mysql: # Database group
          - key: node1
            ...
          - key: node2
            cluster: slave # Handles SQL query operations during read-write separation, master cluster defaults to not writing
            ...
        postgres:
          - key: node1 # Data node
            ...
  ```
- Use the `@Sharding` annotation to switch data sources, with nodes within the group randomly selected by default (read from slave, write to master)
  ```java
  @Mapper
  @Sharding("mysql")
  public interface UserMapper extends BaseMapper<User> {

      @Sharding("postgres")
      Long selectByUsername(String username);

  }
  ```
- Switch to a specific database node
  ```java
  // Switch to mysql slave node2
  ShardingKey.change("mysqlnode2");
  ```

## Dynamic Loading and Unloading of Multiple Data Sources

- Example usage: üëâ [mybatis-mate-sharding-dynamic](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/mybatis-mate-sharding-dynamic)

## Multi-Data Source Transactions (JTA Atomikos)

- Example usage: üëâ [mybatis-mate-sharding-jta-atomikos](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/mybatis-mate-sharding-jta-atomikos)
