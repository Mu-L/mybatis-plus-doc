---
import type { Props } from "@astrojs/starlight/props";
import Default from "@astrojs/starlight/components/PageSidebar.astro";
import Ads from "@/components/Ads.astro";
---

<div class="toc">
  <Default {...Astro.props}>
    <slot />
  </Default>
</div>

<div class="ad">
  <Ads showGoogle={true}/>
</div>

<script lang="js" is:inline>
  document.addEventListener("DOMContentLoaded", function () {
    const toc = document.querySelector(".toc");
    const ad = document.querySelector(".ad");

    if (!toc || !ad) {
      return;
    }

    function adjustLayout() {
      const windowHeight = window.innerHeight;
      const adHeight = ad.offsetHeight;
      const available = Math.max(windowHeight - adHeight - 64, 0);

      toc.style.maxHeight = `${available}px`;
      if (toc.offsetHeight + adHeight > windowHeight) {
        ad.classList.add("fixed-ad");
      } else {
        ad.classList.remove("fixed-ad");
      }
    }

    let adHeight = ad.offsetHeight;
    let heightCheckInterval;
    function startHeightCheck() {
      clearInterval(heightCheckInterval);
      heightCheckInterval = setInterval(() => {
        const newAdHeight = ad.offsetHeight;
        if (newAdHeight !== adHeight) {
          adHeight = newAdHeight;
        } else {
          clearInterval(heightCheckInterval);
          adjustLayout();
        }
      }, 100); // 每100毫秒检查一次高度
    }

    // 监测内容变化时重新布局（包括 Google Adsense 加载）
    const observer = new MutationObserver(startHeightCheck);
    observer.observe(ad, { childList: true, subtree: true, attributes: true });
    
    // 等待 Google Adsense 加载完成后重新计算布局
    if (window.adsbygoogle) {
      const checkAdsLoaded = setInterval(() => {
        const googleAds = ad.querySelector('.adsbygoogle');
        if (googleAds && googleAds.offsetHeight > 0) {
          clearInterval(checkAdsLoaded);
          setTimeout(adjustLayout, 500); // 延迟一点确保完全加载
        }
      }, 200);
    }
    
    // 检测窗口变化时重新布局
    window.addEventListener("resize", adjustLayout);
    adjustLayout();
  });
</script>

<style>
  .toc {
    overflow-y: auto; /* 允许 TOC 内部滚动 */
  }
  .fixed-ad {
    position: fixed;
    bottom: 0;
    width: 100%;
  }
  
  /* 确保广告容器协调 */
  .ad {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
</style>
